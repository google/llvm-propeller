edition = "2023";

package propeller;

option features.field_presence = IMPLICIT;

// Mapping for an address based on the BBAddrMap.
message BasicBlockMapping {
  string function_name = 1;
  int32 bb_id = 2;  // Function-local ID of the basic block.
  int32 subblock_index =
      3;  // Index of the subblock containing the address in the BB entry.
          // The calls in each basic block split it into subblocks, each ending
          // with a call or the end of the basic block.
  int32 subblock_offset =
      4;  // Offset of the address relative to the start of the subblock.
}

// NEXT TAG: 9
message PrefetchHint {
  // The address of the injection site.
  uint64 injection_addr = 1;

  // Mapping from the injection site to the BBAddrMap entry.
  BasicBlockMapping injection_mapping = 3;

  // The overall metric by which prefetches are ranked.
  double score = 4;

  // Expected benefit from injection this prefetch, like the number of misses
  // reduced or cycles saved.
  double expected_benefit = 5;

  // Frequency of occurrences of the injection site.
  double frequency = 6;

  // The average (arithmetic mean) code footprint of all code paths leading
  // from a timely prefetch injection site to the target.
  double average_footprint = 7;

  // Prefetch this many additional contiguous cache lines after target.addr.
  int32 degree = 8;

  reserved 2;
}

// Information about a prefetch target at a specific address.
// NEXT TAG: 7
message PrefetchTarget {
  // The address of the instruction that caused the miss.
  uint64 addr = 1;
  // The frequency of the instruction at the address.
  double execution_count = 2;
  // The total misses at the target.
  double miss_count = 3;
  // Mapping from the address to the BBAddrMap entry.
  BasicBlockMapping mapping = 4;
  // The set of prefetch hints generated for this target.
  repeated PrefetchHint hints = 6;

  reserved 5;
}

// PrefetchTargets represents a set of PrefetchTargets.
message PrefetchTargets {
  repeated PrefetchTarget targets = 1;
}
