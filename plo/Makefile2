# Customizable variables.
# Vanilla clang/clang++ bin path.
SHELL := /bin/bash

paths.mk :
	@if [[ ! -e "paths.mk" ]] ; then \
		touch $@ ; \
		echo "RELEASE_LLVM_BIN=/path/to/llvm/bin" >> $@ ; \
		echo "CREATE_LLVM_PROF_DIR=/path/to/create_llvm_prof_dir" >> $@ ; \
		echo "BOLT=/path/to/llvm-bolt" >> $@ ; \
		echo "PERF2BOLT=/path/to/perf2bolt" >> $@ ; \
		echo "PROTOBUF_PREFIX=" >> $@ ; \
		exit 1 ; \
	fi

include paths.mk
ifeq '${CREATE_LLVM_PROF_DIR}' ''
CREATE_LLVM_PROF_DIR=$(shell pwd)/..
endif

check_environment: paths.mk
	@if [[ ! -e "${RELEASE_LLVM_BIN}/clang" ]] || \
	    [[ ! -d "${CREATE_LLVM_PROF_DIR}" ]] ; then \
	  echo "Invalid entries found in \"paths.mk\", please check." ; \
	  exit 1 ; \
	fi
	touch $@


CREATE_LLVM_PROF=${CREATE_LLVM_PROF_DIR}/create_llvm_prof
DDIR := $(shell pwd)
LLVM_PROJECT := $(shell cd $(DDIR)/.. && pwd)
LLVM_SOURCE := $(shell find $(LLVM_PROJECT)/llvm \
                            $(LLVM_PROJECT)/clang \
                            $(LLVM_PROJECT)/lld \
        '(' -ipath "*/.git"      -o      \
            -ipath "*/test"      -o      \
            -ipath "*/tests"     -o      \
            -ipath "*/unittests" -o      \
            -ipath "*/gtest"     -o      \
            -ipath "*/googletest" ')' -type d  -prune -o \
        -type f '(' -iname "*.cpp" -o -iname "*.cc" -o -iname "*.c" \
                   -o -iname "*.h" -o -iname "*.td" ')' -print)

ifeq ($(J_NUMBER),)
J_NUMBER := $(shell grep -Ee "^core id" /proc/cpuinfo | wc -l)
J_NUMBER := $(shell if [[ "$(J_NUMBER)" -lt "16" ]] ; then \
                        echo $$(($(J_NUMBER) / 8 * 7)) ; \
                    else echo $$(($(J_NUMBER) - 5)); fi)
endif

STAGE1_BIN         := $(DDIR)/stage1/install/bin
PROFILES_DIR       := $(DDIR)/stage2/build/profiles

# $1 are compiler flags.
# $2 are ld flags.
gen_build_flags = -DCMAKE_C_FLAGS=$(1) -DCMAKE_CXX_FLAGS=$(1) \
                  -DCMAKE_EXE_LINKER_FLAGS=$(2) \
                  -DCMAKE_SHARED_LINKER_FLAGS=$(2) \
                  -DCMAKE_MODULE_LINKER_FLAGS=$(2)

RELOCATION_GEN_OPT := -fuse-ld=lld -Wl,-q

gen_lld_flags = -DCMAKE_EXE_LINKER_FLAGS=$(1) -DCMAKE_SHARED_LINKER_FLAGS=$(1) -DCMAKE_MODULE_LINKER_FLAGS=$(1)

gen_build_flags = -DCMAKE_C_FLAGS=$(1) -DCMAKE_CXX_FLAGS=$(1) $(call gen_lld_flags,$(2))

ifdef PROTOBUF_PREFIX
cmake_protobuf_statements := -DProtobuf_PROTOC_EXECUTABLE=$(PROTOBUF_PREFIX)/bin/protoc -DProtobuf_INCLUDE_DIR=$(PROTOBUF_PREFIX)/include -DProtobuf_LIBRARY=$(PROTOBUF_PREFIX)/lib/libprotobuf.so
else
cmake_protobuf_statements :=
endif

# $1 is bin directory that is used to build the compiler, must be absolute path.
# $2 is any other cmake flags (optional)
# $3 is llvm enabled projects
# $4 is target
# $5 is Release / Debug / RelWithDebInfo
define build_compiler
	export COMP_DIR=$$(echo $@ | sed -Ee 's!([^/]+)/.*!\1!') ; \
        if [[ -z "$(5)" ]]; then                                   \
           BuildType="Release" ;                                   \
        else                                                       \
           BuildType="$(5)" ;                                      \
        fi ;                                                       \
	if [[ ! -e "$${COMP_DIR}/build/CMakeCache.txt" ]]; then    \
	  mkdir -p $${COMP_DIR}/build ;                            \
	  pushd $${COMP_DIR}/build && cmake -G Ninja               \
            -DCMAKE_INSTALL_PREFIX=$(DDIR)/$${COMP_DIR}/install    \
	    -DCMAKE_BUILD_TYPE=$${BuildType}                       \
            -DLLVM_OPTIMIZED_TABLEGEN=On                           \
            -DLLVM_TARGETS_TO_BUILD="X86"                          \
	    -DLLVM_USE_LINKER="lld"	                           \
	    -DCMAKE_C_COMPILER=$(1)/clang                          \
	    -DCMAKE_CXX_COMPILER=$(1)/clang++                      \
	    -DCMAKE_ASM_COMPILER=$(1)/clang                        \
	    $(2)                                                   \
            -DLLVM_ENABLE_PROJECTS=$(3)                            \
            $(LLVM_PROJECT)/llvm;                                  \
	  popd ;                                                   \
	fi ;                                                       \
        ninja -C $${COMP_DIR}/build -j$(J_NUMBER) $(4) ;           \
	touch $@
endef

##
COMPILERS=stage_pgo debug protobuf pgo_relocs pgo_vanilla pgo_labels pgo_plolist pgo_ploall

comma := ,

stage1/install/bin/clang: check_environment $(LLVM_SOURCE)
	$(call build_compiler,$(RELEASE_LLVM_BIN),,"clang;compiler-rt;lld",install)

stage1-compiler: stage1/install/bin/clang
	ln -sf $< $@
	touch $@

debug/build/bin/clang-10: check_environment $(LLVM_SOURCE)
	$(call build_compiler,$(RELEASE_LLVM_BIN),,"clang;compiler-rt;lld",clang lld,Debug)

protobuf/build/bin/clang-10: check_environment $(LLVM_SOURCE)
	@if [[ ! -d "$(PROTOBUF_PREFIX)" ]]; then \
	  echo "Invalid PROTOBUF_PREFIX in paths.mk." ; exit 1 ; \
	fi
	$(call build_compiler,$(RELEASE_LLVM_BIN),-DProtobuf_PROTOC_EXECUTABLE=$(PROTOBUF_PREFIX)/bin/protoc -DProtobuf_INCLUDE_DIR=$(PROTOBUF_PREFIX)/include -DProtobuf_LIBRARY=$(PROTOBUF_PREFIX)/lib/libprotobuf.so \
		-DCMAKE_EXE_LINKER_FLAGS="-Wl$(comma)-rpath=$(PROTOBUF_PREFIX)/lib","clang;compiler-rt;lld",clang lld,Release)

stage_pgo/build/bin/clang-10: | stage1-compiler
	$(call build_compiler,$(DDIR)/stage1/install/bin,-DLLVM_BUILD_INSTRUMENTED=IR,"clang;lld",all)

stage_pgo-compiler.profdata: %.profdata: % run-commands.sh  | stage1-compiler
	./run-commands.sh $(shell readlink -f $<)
	$(STAGE1_BIN)/llvm-profdata merge -output=$@ `find $(dir $(shell readlink -f $<))../ -path "*/profiles/*.profraw"`

pgo_relocs/build/bin/clang-10: stage_pgo-compiler.profdata
	$(call build_compiler,$(DDIR)/stage1/install/bin,-DLLVM_PROFDATA_FILE="$(DDIR)/$<" -DLLVM_ENABLE_LTO=Thin $(call gen_build_flags,,"$(RELOCATION_GEN_OPT)"),"clang;lld",clang lld)

pgo_vanilla/build/bin/clang-10: stage_pgo-compiler.profdata
	$(call build_compiler,$(DDIR)/stage1/install/bin,-DLLVM_PROFDATA_FILE="$(DDIR)/$<" -DLLVM_ENABLE_LTO=Thin,"clang;lld",clang lld)

pgo_labels/build/bin/clang-10: stage_pgo-compiler.profdata
	$(call build_compiler,$(DDIR)/stage1/install/bin,-DLLVM_PROFDATA_FILE="$(DDIR)/$<" -DLLVM_ENABLE_LTO=Thin $(call gen_build_flags,"-fpropeller-label","-fuse-ld=lld -fpropeller-label"),"clang;lld",clang lld)

pgo_relocs-compiler.perfdata pgo_vanilla-compiler.perfdata pgo_labels-compiler.perfdata: %.perfdata: % run-commands.sh
	perf record -o $@ -e cycles:u -j any,u -- ./run-commands.sh $(shell readlink -f $<)

pgo_relocs-compiler.yaml pgo_vanilla-compiler.yaml pgo_labels-compiler.yaml: %.yaml: %.perfdata %
	$(PERF2BOLT) -o $(subst .perfdata,.fdata,$<) -w $@ -p $< $(shell readlink -f $(word 2,$^))

pgo_labels-compiler.propeller: pgo_labels-compiler pgo_labels-compiler.perfdata
	${CREATE_LLVM_PROF} --binary=`readlink -f $<` --format=propeller --profile=$(lastword $^) --out=$@ --logtostderr

pgo_plolist/build/bin/clang-10: stage_pgo-compiler.profdata pgo_labels-compiler.propeller
	$(call build_compiler,$(DDIR)/stage1/install/bin,\
		-DLLVM_PROFDATA_FILE="$(DDIR)/$<" -DLLVM_ENABLE_LTO=Thin \
		$(call gen_build_flags,"-fpropeller-optimize=$(DDIR)/$(lastword $^)","-fuse-ld=lld -fpropeller-optimize=$(DDIR)/$(lastword $^)"),"clang;lld",clang lld)

pgo_ploall/build/bin/clang-10: stage_pgo-compiler.profdata pgo_labels-compiler.propeller
	$(call build_compiler,$(DDIR)/stage1/install/bin,\
		-DLLVM_PROFDATA_FILE="$(DDIR)/$<" -DLLVM_ENABLE_LTO=Thin \
		$(call gen_build_flags,"-fpropeller-optimize=$(DDIR)/$(lastword $^) -fbasicblock-sections=all","-fuse-ld=lld -fpropeller-optimize=$(DDIR)/$(lastword $^) -Wl$(comma)-lto-basicblock-sections=all"),"clang;lld",clang lld)

pgo_relocs_bolt-compiler: pgo_relocs-compiler.yaml
	$(BOLT) $(shell readlink -f "$$(basename $< .yaml)") -o $@ -b $< -split-functions=3 -reorder-blocks="cache+" -reorder-functions="hfsort" -relocs=1 --update-debug-sections 2>&1 | tee $@.autolog

$(foreach C,$(COMPILERS),$(C)-compiler): %-compiler: %/build/bin/clang-10
	ln -sf $< $@
	touch $@

run-commands.sh: | stage1-compiler
	rsync -a -f "+ */" -f "+ *.inc" -f "+ *.h" -f "+ *.def" -f "- *" \
            stage1/build/ test-build/
	ninja -C stage1/build -t commands clang \
            | grep -E "^$(RELEASE_LLVM_BIN)/clang\+?\+? " \
            | grep -Fe " -c " \
            | sed -Ee 's!^$(RELEASE_LLVM_BIN)/clang\+\+ !$${CCP} -x c++ !' \
                   -e 's!^$(RELEASE_LLVM_BIN)/clang !$${CCP} !' \
                   -e 's!^!cd $(DDIR)/test-build \&\& !' >> commands
	if [[ -z `cat commands` ]]; then \
		echo "Empty commands file, ERROR." ; exit 1 ; \
	fi
	echo "export CCP=\$$1" > $@
	echo "head -n 666 commands | xargs -P50 -L1 -d \"\\n\" bash -x -c" \
                >> $@
	chmod +x $@

benchmark-stage1 benchmark-pgo_vanilla benchmark-pgo_plolist benchmark-pgo_ploall: benchmark-%: %-compiler run-commands.sh
	/usr/bin/time --format "USER:%U SYS:%S WALL:%e STATUS:%x" ./run-commands.sh $(shell readlink -f $<)

clean:
	rm -fr $(foreach C,$(COMPILERS),$(C)-compiler $(C)/ $(C)-compiler.perfdata{,.old} $(C)-compiler.yaml)
	rm -f run-commands.sh
	rm -f stage_pgo-compiler.profdata
	rm -f pgo_labels-compiler.propeller
	rm -f commands check_environment
	rm -fr test-build

clean-all: clean
	rm -fr stage1-compiler stage1/
